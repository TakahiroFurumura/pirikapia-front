import{a as j,b as G,c as J,Q as P,_ as U}from"./interfaces-CEDtc8E9.js";import{d as C}from"./QBtn-DbeY89k7.js";import{Q as $}from"./QCardSection-zJr2BKdT.js";import{Q as H}from"./QCard-DdHPO4_y.js";import{u as K,a as y}from"./axios-CzASkJXF.js";import{B as W,r as c,a as u,b as X,w as Y,O as m,G as l,F as w,E as r,N as p,S as D,Q,M as Z,T as ee,D as n,C as B,L as ae,I as _,J as v}from"./index-CSmHNlDl.js";import"./use-dark-BnAV-e0o.js";import"./use-timeout-D3NUh7MW.js";const oe={class:"q-pa-md q-gutter-sm"},te={class:"text-caption q-ml-sm"},re={key:0,class:"row q-col-gutter-xs"},ge=W({__name:"ImageDetailView",props:{imageId:{}},setup(S){const k=K(),x=Z(),F=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}),d=S,h=c([]),o=c(null),g=c(!1),s=c(null),b=c([]),E=u(()=>o.value?.created_on?F.format(new Date(o.value?.created_on)):""),T=u(()=>0+(f.value?1:0)),N=u(()=>0),V=u(()=>o.value!==null?o.value.owner_username:""),A=u(()=>o.value!==null&&o.value.width!==void 0&&o.value.height!==void 0?o.value.width/o.value.height:1),f=c(!1),L=u(()=>f.value?"favorite":"favorite_border"),R=u(()=>f.value?"pink":"primary");function z(e){return`/?tag=${e}`}const M=async()=>{await y.get(`/images/hashid/${d.imageId}/`).then(e=>{o.value=e.data,b.value=Object.keys(e.data.tags),f.value=e.data.bookmark}).catch(e=>{console.log(e)})},I=async()=>{g.value=!0,s.value=null,o.value=null;try{await M()}catch(e){console.error("Failed to load an image:",e),e instanceof Error?s.value=e:s.value=new Error(String(e))}finally{g.value=!1}},q=async()=>{g.value=!0,s.value=null;try{let e;d.imageId!==null?(console.debug(d.imageId),e=`/images/similar/${d.imageId}/12/`):(console.error("loading random thumbnails instead of similar images"),e="/images/random-thumbnails/12/"),await y.get(e).then(t=>{const i=t.data;h.value=i.map(a=>j(a))})}catch(e){console.error("Failed to fetch image data:",e),e instanceof Error?s.value=e:s.value=new Error("An unknown error occurred")}finally{g.value=!1}};function O(){f.value||o.value!==null&&(console.debug(`toggleBookmark ${o.value.filename} ${k.user}`),k.isAuthenticated?y.post(`/images/bookmark/${o.value.image_id}/`,{}).then(()=>{console.debug(`added to ${k.user.username} bookmark.`)}).catch(e=>{console.error(e.message)}):x.push("/user-login"))}return X(()=>{I().catch(e=>console.error(e)),q().catch(e=>console.error(e))}),Y(()=>d.imageId,(e,t)=>{e!==t&&e&&(console.log(`Image ID changed from ${t} to ${e}. Reloading data.`),I().then(()=>{q().catch(i=>console.error(i))}).catch(i=>console.error(i)))}),(e,t)=>{const i=ee("router-link");return n(),m("div",oe,[l(H,{flat:""},{default:r(()=>[l(G,{src:o.value?.signed_url,"spinner-color":"grey",ratio:A.value,"spinner-size":"82px",style:{position:"relative"}},{error:r(()=>t[1]||(t[1]=[p("div",{class:"absolute-full flex flex-center bg-negative text-white"}," Failed to load... ",-1)])),default:r(()=>[o.value?.requires_login?(n(),m("div",{key:0,class:"absolute-full text-subtitle1 flex flex-center",style:{cursor:"pointer","background-color":"rgba(0, 0, 0, 0.3)",color:"white",padding:"2px"},onClick:t[0]||(t[0]=a=>ae(x).push("/user-login"))},t[2]||(t[2]=[p("span",{class:""},"Login to unlock",-1)]))):w("",!0)]),_:1},8,["src","ratio"]),l(J,{align:"left",class:"q-mx-none q-pa-none q-my-none"},{default:r(()=>[l(C,{flat:"",round:"",size:"md",color:R.value,icon:L.value,class:"q-ml-none",onClick:O},{default:r(()=>[_(v(T.value),1)]),_:1},8,["color","icon"]),l(C,{flat:"",round:"",size:"md",color:"primary",icon:"comment",class:"q-ml-sm"},{default:r(()=>[_(v(N.value),1)]),_:1}),p("div",te,"by "+v(V.value),1)]),_:1}),b.value.length>0?(n(),B($,{key:0},{default:r(()=>[(n(!0),m(D,null,Q(b.value,a=>(n(),B(P,{color:"primary","text-color":"white",key:a,class:"q-mx-xs q-px-sm"},{default:r(()=>[l(i,{to:z(a),style:{"text-decoration":"none",color:"white"}},{default:r(()=>[_(v(a.replace(/_/g," ")),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):w("",!0),l($,{class:"text-caption"},{default:r(()=>[_(v(E.value),1)]),_:1})]),_:1}),!g.value&&!s.value&&h.value.length>0?(n(),m("div",re,[t[3]||(t[3]=p("p",{class:"text-subtitle1 col-12"},"more like this",-1)),(n(!0),m(D,null,Q(h.value,a=>(n(),m("div",{key:a.filename,class:"col-xs-12 col-sm-6 col-md-4 col-lg-3"},[l(U,{filename:a.filename,image_id:a.image_id,signed_url:a.signed_url,owner_username:a.owner_username,title:a.title,comment_count:a.comment_count,requires_login:a.requires_login,bookmark:a.bookmark,bookmark_count:a.bookmark_count},null,8,["filename","image_id","signed_url","owner_username","title","comment_count","requires_login","bookmark","bookmark_count"])]))),128))])):w("",!0)])}}});export{ge as default};
