import{a as U,Q as W,b as X}from"./interfaces-CJZOsaBi.js";import{Q as $}from"./QBtn-CT6Dl0K4.js";import{Q as Y}from"./QChip-BY0XlfPP.js";import{Q as B}from"./QCardSection-Dw9bX3LI.js";import{Q as G}from"./QCard-DhPiEgWF.js";import{u as H,a as w}from"./auth-DLqiCEvD.js";import{L as J,r as c,a as l,I as K,w as Z,X as m,Q as n,P as x,O as r,W as g,_ as D,Y as S,V as ee,$ as ae,N as s,M as F,U as oe,R as p,S as f}from"./index-DDJCu69c.js";import{_ as te}from"./ImageThumbnail.vue_vue_type_script_setup_true_lang-BO06UdZe.js";import"./use-router-link-CdVA7K5L.js";import"./use-timeout-DOCYTK08.js";import"./use-dark-CBgOFpCW.js";import"./QSeparator-DvC_D7Y8.js";const re={class:"q-pa-md q-gutter-sm"},le=["href"],ne={class:"text-caption q-ml-sm"},se={key:0,class:"row q-col-gutter-xs"},be=J({__name:"ImageDetailView",props:{imageId:{}},setup(T){const h=H(),I=ee(),V=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}),d=T,b=c([]),a=c(null),v=c(!1),u=c(null),y=c([]),A=l(()=>a.value?.created_on?V.format(new Date(a.value?.created_on)):""),E=l(()=>0),L=l(()=>a.value!==null?a.value.owner_username:""),N=l(()=>a.value!==null&&a.value.width!==void 0&&a.value.height!==void 0?a.value.width/a.value.height:1),R=l(()=>a.value!==void 0&&a.value!==null?a.value.signed_url:""),_=c(!1),k=c(!1),z=l(()=>_.value||k.value||q.value>0?"favorite":"favorite_border"),M=l(()=>_.value||k.value?"pink":"primary"),q=l(()=>a.value!=null&&a.value!==null?a.value.bookmark_count+(k.value?1:0):0);function O(e){return`/?tag=${e}`}const j=async()=>{await w.get(`/images/hashid/${d.imageId}/`).then(e=>{a.value=e.data,y.value=Object.keys(e.data.tags),_.value=e.data.bookmark}).catch(e=>{console.log(e)})},C=async()=>{v.value=!0,u.value=null,a.value=null;try{await j()}catch(e){console.error("Failed to load an image:",e),e instanceof Error?u.value=e:u.value=new Error(String(e))}finally{v.value=!1}},Q=async()=>{v.value=!0,u.value=null;try{let e;d.imageId!==null?(console.debug(d.imageId),e=`/images/similar/${d.imageId}/12/`):(console.error("loading random thumbnails instead of similar images"),e="/images/random-thumbnails/12/"),await w.get(e).then(t=>{const i=t.data;b.value=i.map(o=>U(o))})}catch(e){console.error("Failed to fetch image data:",e),e instanceof Error?u.value=e:u.value=new Error("An unknown error occurred")}finally{v.value=!1}};function P(){_.value||a.value!==null&&(console.debug(`toggleBookmark ${a.value.filename} ${h.user}`),h.isAuthenticated?w.post(`/images/bookmark/${a.value.image_id}/`,{}).then(()=>{console.debug(`added to ${h.user.username} bookmark.`),k.value=!0}).catch(e=>{console.error(e.message)}):I.push("/user-login"))}return K(()=>{C().catch(e=>console.error(e)),Q().catch(e=>console.error(e))}),Z(()=>d.imageId,(e,t)=>{e!==t&&e&&(console.log(`Image ID changed from ${t} to ${e}. Reloading data.`),C().then(()=>{Q().catch(i=>console.error(i))}).catch(i=>console.error(i)))}),(e,t)=>{const i=ae("router-link");return s(),m("div",re,[n(G,{flat:""},{default:r(()=>[g("a",{href:R.value,target:"_blank"},[n(W,{src:a.value?.signed_url,"spinner-color":"grey",ratio:N.value,"spinner-size":"82px",style:{position:"relative"}},{error:r(()=>t[1]||(t[1]=[g("div",{class:"absolute-full flex flex-center bg-grey text-white"}," Failed to load... ",-1)])),default:r(()=>[a.value?.requires_login?(s(),m("div",{key:0,class:"absolute-full text-subtitle1 flex flex-center",style:{cursor:"pointer","background-color":"rgba(0, 0, 0, 0.3)",color:"white",padding:"2px"},onClick:t[0]||(t[0]=o=>oe(I).push("/user-login"))},t[2]||(t[2]=[g("span",{class:""},"Login to unlock",-1)]))):x("",!0)]),_:1},8,["src","ratio"])],8,le),n(X,{align:"left",class:"q-mx-none q-pa-none q-my-none"},{default:r(()=>[n($,{flat:"",round:"",size:"md",color:M.value,icon:z.value,class:"q-ml-none",onClick:P},{default:r(()=>[p(f(q.value),1)]),_:1},8,["color","icon"]),n($,{flat:"",round:"",size:"md",color:"primary",icon:"comment",class:"q-ml-sm"},{default:r(()=>[p(f(E.value),1)]),_:1}),g("div",ne,"by "+f(L.value),1)]),_:1}),y.value.length>0?(s(),F(B,{key:0},{default:r(()=>[(s(!0),m(D,null,S(y.value,o=>(s(),F(Y,{color:"primary","text-color":"white",key:o,class:"q-mx-xs q-px-sm"},{default:r(()=>[n(i,{to:O(o),style:{"text-decoration":"none",color:"white"}},{default:r(()=>[p(f(o.replace(/_/g," ")),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):x("",!0),n(B,{class:"text-caption"},{default:r(()=>[p(f(A.value),1)]),_:1})]),_:1}),!v.value&&!u.value&&b.value.length>0?(s(),m("div",se,[t[3]||(t[3]=g("p",{class:"text-subtitle1 col-12"},"more like this",-1)),(s(!0),m(D,null,S(b.value,o=>(s(),m("div",{key:o.filename,class:"col-xs-12 col-sm-6 col-md-4 col-lg-3"},[n(te,{filename:o.filename,image_id:o.image_id,signed_url:o.signed_url,owner_username:o.owner_username,title:o.title,comment_count:o.comment_count,requires_login:o.requires_login,bookmark:o.bookmark,bookmark_count:o.bookmark_count},null,8,["filename","image_id","signed_url","owner_username","title","comment_count","requires_login","bookmark","bookmark_count"])]))),128))])):x("",!0)])}}});export{be as default};
