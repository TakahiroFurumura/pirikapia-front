import{a as G,b as J,c as U,Q as H}from"./interfaces-aGxEP7vb.js";import{Q as B}from"./QBtn-5I6PZM-i.js";import{Q as D}from"./QCardSection-D34gRZDi.js";import{Q as K}from"./QCard-xFlhgNkg.js";import{u as W,a as x}from"./axios-B6YjhwR7.js";import{B as X,r as c,a as l,x as Y,w as Z,O as m,G as n,F as w,E as r,N as g,R as Q,P as S,M as ee,S as ae,D as s,C as F,L as oe,I as p,J as f}from"./index-Bq6dgnb6.js";import{_ as te}from"./ImageThumbnail.vue_vue_type_script_setup_true_lang-Cb2gItdA.js";import"./use-router-link-DQvo0l9p.js";import"./use-dark-BKWEFA6b.js";import"./use-timeout-BsUAoSfw.js";import"./QSeparator-I7S8oxPG.js";const re={class:"q-pa-md q-gutter-sm"},le=["href"],ne={class:"text-caption q-ml-sm"},se={key:0,class:"row q-col-gutter-xs"},he=X({__name:"ImageDetailView",props:{imageId:{}},setup(E){const h=W(),I=ee(),T=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}),d=E,b=c([]),a=c(null),v=c(!1),u=c(null),y=c([]),A=l(()=>a.value?.created_on?T.format(new Date(a.value?.created_on)):""),L=l(()=>0),N=l(()=>a.value!==null?a.value.owner_username:""),R=l(()=>a.value!==null&&a.value.width!==void 0&&a.value.height!==void 0?a.value.width/a.value.height:1),V=l(()=>a.value!==void 0&&a.value!==null?a.value.signed_url:""),k=c(!1),_=c(!1),z=l(()=>k.value||_.value||q.value>0?"favorite":"favorite_border"),M=l(()=>k.value||_.value?"pink":"primary"),q=l(()=>a.value!=null&&a.value!==null?a.value.bookmark_count+(_.value?1:0):0);function O(e){return`/?tag=${e}`}const j=async()=>{await x.get(`/images/hashid/${d.imageId}/`).then(e=>{a.value=e.data,y.value=Object.keys(e.data.tags),k.value=e.data.bookmark}).catch(e=>{console.log(e)})},C=async()=>{v.value=!0,u.value=null,a.value=null;try{await j()}catch(e){console.error("Failed to load an image:",e),e instanceof Error?u.value=e:u.value=new Error(String(e))}finally{v.value=!1}},$=async()=>{v.value=!0,u.value=null;try{let e;d.imageId!==null?(console.debug(d.imageId),e=`/images/similar/${d.imageId}/12/`):(console.error("loading random thumbnails instead of similar images"),e="/images/random-thumbnails/12/"),await x.get(e).then(t=>{const i=t.data;b.value=i.map(o=>G(o))})}catch(e){console.error("Failed to fetch image data:",e),e instanceof Error?u.value=e:u.value=new Error("An unknown error occurred")}finally{v.value=!1}};function P(){k.value||a.value!==null&&(console.debug(`toggleBookmark ${a.value.filename} ${h.user}`),h.isAuthenticated?x.post(`/images/bookmark/${a.value.image_id}/`,{}).then(()=>{console.debug(`added to ${h.user.username} bookmark.`),_.value=!0}).catch(e=>{console.error(e.message)}):I.push("/user-login"))}return Y(()=>{C().catch(e=>console.error(e)),$().catch(e=>console.error(e))}),Z(()=>d.imageId,(e,t)=>{e!==t&&e&&(console.log(`Image ID changed from ${t} to ${e}. Reloading data.`),C().then(()=>{$().catch(i=>console.error(i))}).catch(i=>console.error(i)))}),(e,t)=>{const i=ae("router-link");return s(),m("div",re,[n(K,{flat:""},{default:r(()=>[g("a",{href:V.value,target:"_blank"},[n(J,{src:a.value?.signed_url,"spinner-color":"grey",ratio:R.value,"spinner-size":"82px",style:{position:"relative"}},{error:r(()=>t[1]||(t[1]=[g("div",{class:"absolute-full flex flex-center bg-grey text-white"}," Failed to load... ",-1)])),default:r(()=>[a.value?.requires_login?(s(),m("div",{key:0,class:"absolute-full text-subtitle1 flex flex-center",style:{cursor:"pointer","background-color":"rgba(0, 0, 0, 0.3)",color:"white",padding:"2px"},onClick:t[0]||(t[0]=o=>oe(I).push("/user-login"))},t[2]||(t[2]=[g("span",{class:""},"Login to unlock",-1)]))):w("",!0)]),_:1},8,["src","ratio"])],8,le),n(U,{align:"left",class:"q-mx-none q-pa-none q-my-none"},{default:r(()=>[n(B,{flat:"",round:"",size:"md",color:M.value,icon:z.value,class:"q-ml-none",onClick:P},{default:r(()=>[p(f(q.value),1)]),_:1},8,["color","icon"]),n(B,{flat:"",round:"",size:"md",color:"primary",icon:"comment",class:"q-ml-sm"},{default:r(()=>[p(f(L.value),1)]),_:1}),g("div",ne,"by "+f(N.value),1)]),_:1}),y.value.length>0?(s(),F(D,{key:0},{default:r(()=>[(s(!0),m(Q,null,S(y.value,o=>(s(),F(H,{color:"primary","text-color":"white",key:o,class:"q-mx-xs q-px-sm"},{default:r(()=>[n(i,{to:O(o),style:{"text-decoration":"none",color:"white"}},{default:r(()=>[p(f(o.replace(/_/g," ")),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):w("",!0),n(D,{class:"text-caption"},{default:r(()=>[p(f(A.value),1)]),_:1})]),_:1}),!v.value&&!u.value&&b.value.length>0?(s(),m("div",se,[t[3]||(t[3]=g("p",{class:"text-subtitle1 col-12"},"more like this",-1)),(s(!0),m(Q,null,S(b.value,o=>(s(),m("div",{key:o.filename,class:"col-xs-12 col-sm-6 col-md-4 col-lg-3"},[n(te,{filename:o.filename,image_id:o.image_id,signed_url:o.signed_url,owner_username:o.owner_username,title:o.title,comment_count:o.comment_count,requires_login:o.requires_login,bookmark:o.bookmark,bookmark_count:o.bookmark_count},null,8,["filename","image_id","signed_url","owner_username","title","comment_count","requires_login","bookmark","bookmark_count"])]))),128))])):w("",!0)])}}});export{he as default};
