import{Q as H}from"./use-router-link-DHbFeyIZ.js";import{Q as M}from"./QSeparator-DHJMw6a2.js";import{Q as B}from"./QCardSection-VDfp5xIU.js";import{Q as E}from"./QBtn-Cgmgakfy.js";import{a as W,b as Y}from"./interfaces-mmqTB_Cm.js";import{Q as Z}from"./QCard-Dgu91nSk.js";import{Q as ee}from"./QDialog-C8IGqPNZ.js";import{y as oe,t as te,I as K,a as q,F as N,U as g,K as v,T as e,a4 as D,N as t,Q as F,L as h,P as I,M as S,r as f,w as ae,X as T,a5 as ne,V as P,J as se,O,R as le,G as R}from"./index-7caSP31t.js";import{k as re,l as ie}from"./focusout-DEGXVdQK.js";import{u as U}from"./uiconfig-B05de8GS.js";import{_ as j}from"./ImageBox.vue_vue_type_script_setup_true_lang-DqixTdiD.js";import{Q as ce}from"./QInput-DvQSfkEM.js";import{Q as de}from"./QChip-DYjRA0xl.js";import{Q as ue}from"./QPagination-C87-Nozn.js";import{Q as me}from"./QSpinnerGears-FhtbVfVl.js";import{_ as pe}from"./ImageThumbnail.vue_vue_type_script_setup_true_lang-DJ3E9ctd.js";import{a as V}from"./auth-CDSO7_SK.js";function z(a){if(a===!1)return 0;if(a===!0||a===void 0)return 1;const r=parseInt(a,10);return isNaN(r)?0:r}const A=oe({name:"close-popup",beforeMount(a,{value:r}){const i={depth:z(r),handler(c){i.depth!==0&&setTimeout(()=>{const o=re(a);o!==void 0&&ie(o,c,i.depth)})},handlerKey(c){te(c,13)===!0&&i.handler(c)}};a.__qclosepopup=i,a.addEventListener("click",i.handler),a.addEventListener("keyup",i.handlerKey)},updated(a,{value:r,oldValue:i}){r!==i&&(a.__qclosepopup.depth=z(r))},beforeUnmount(a){const r=a.__qclosepopup;a.removeEventListener("click",r.handler),a.removeEventListener("keyup",r.handlerKey),delete a.__qclosepopup}}),ve={class:"row"},ge={class:"text-h5 q-my-sm"},fe={class:"col-12"},he={class:"row"},_e={key:0,class:"col-12 col-md-6 col-lg-6 col-xl-6"},ye={class:"q-mx-md"},Ie=K({__name:"NovelCoverChapter",props:{novelId:{},chapterStrId:{},chapterTitle:{default:""},coverImage:{default:""},description:{default:""},descriptionMaxLength:{default:250}},setup(a){const r=U(),i=r.isDebugMode,c=q(()=>o.description.substring(0,o.descriptionMaxLength-1)),o=a,_=q(()=>`/novel-chapter/${o.novelId}/${o.chapterStrId}/${r.language}`);return N(()=>{i&&console.debug("props",o)}),(w,s)=>{const y=F("router-link");return v(),g("div",ve,[e("div",{class:D((o.descriptionMaxLength>0,"col-12"))},[t(y,{to:_.value,style:{"text-decoration":"none"}},{default:h(()=>[e("span",ge,I(o.chapterTitle),1)]),_:1},8,["to"])],2),e("div",fe,[e("div",he,[e("div",{class:D(o.descriptionMaxLength>0?"col-12 col-md-6 col-lg-6 col-xl-6":"col-12")},[t(j,{imageId:o.coverImage,enableLinkToImageDetailView:!1,showTags:!1,showPublishedDate:!1,showButtons:!1,"link-to":_.value,"height-percent":o.descriptionMaxLength>0?100:null,"crop-aspect-ratio":o.descriptionMaxLength>0?null:1},null,8,["imageId","link-to","height-percent","crop-aspect-ratio"])],2),o.descriptionMaxLength>0?(v(),g("div",_e,[t(y,{to:_.value,style:{"text-decoration":"none"}},{default:h(()=>[e("div",ye,I(c.value)+"... ",1)]),_:1},8,["to"])])):S("",!0)])])])}}}),ke={class:"q-my-md"},be={class:"q-pa-md flex flex-center"},we={class:""},xe={key:0,class:"q-my-lg text-center"},$e={class:"row"},Ce=["onClick"],Se=K({__name:"ImageSelector",props:{ownerId:{},multiSelection:{type:Boolean,default:!1}},emits:["imageSelected"],setup(a,{emit:r}){U().isDebugMode&&console.debug("NovelCover loaded");const o=a,_=r,w=f([]),s=f(!0),y=f(null),$=f([]),C=f(12),x=f(1),Q=f(0),u=q(()=>Math.ceil(Q.value/C.value));ae(x,()=>{L().catch(l=>console.error(l))});const m=f(""),k=f([]),d=q(()=>{const l=[`owner=${o.ownerId}`,"orderby=-created_on",`n=${C.value}`,`offset=${((x.value-1)*C.value).toString()}`],p=k.value.map(n=>`keyword=${encodeURIComponent(n)}`);return l.concat(p).join("&")}),L=async()=>{$.value=[],s.value=!0,y.value=null;try{const l=`/images/search/?${d.value}`;await V.get(l).then(p=>{const n=p.data;$.value=n.map(b=>W(b)),V.get(l.replace("search/","search/count/")).then(b=>{Q.value=b.data.count})}).catch(p=>{console.log(p)})}catch(l){console.error("Failed to fetch image data:",l),l instanceof Error?y.value=l:y.value=new Error("An unknown error occurred")}finally{s.value=!1}};function G(){m.value&&(k.value.push(m.value),m.value="",L().catch(l=>console.error(l)))}function J(l){k.value.splice(l,1),L().catch(p=>console.error(p))}function X(l){o.multiSelection?console.log("not yet"):(w.value=[l],_("imageSelected",w.value))}return N(()=>{L().catch(l=>console.error(l))}),(l,p)=>(v(),g(T,null,[t(ce,{dense:"",modelValue:m.value,"onUpdate:modelValue":p[0]||(p[0]=n=>m.value=n),autofocus:"",onKeyup:ne(G,["enter"]),label:"search keyword"},null,8,["modelValue"]),e("div",ke,[(v(!0),g(T,null,P(k.value,(n,b)=>(v(),se(de,{key:b,removable:"",bold:"",onRemove:Ee=>J(b)},{default:h(()=>[O(I(n),1)]),_:2},1032,["onRemove"]))),128))]),e("div",be,[t(ue,{modelValue:x.value,"onUpdate:modelValue":p[1]||(p[1]=n=>x.value=n),max:u.value,input:""},null,8,["modelValue","max"])]),e("div",we,[s.value?(v(),g("div",xe,[t(me,{size:"50px",color:"primary"}),p[2]||(p[2]=e("p",null,"Loading...",-1))])):S("",!0),e("div",$e,[(v(!0),g(T,null,P($.value,n=>(v(),g("div",{key:n.filename,class:"col-xs-12 col-sm-6 col-md-4 col-lg-3",onClick:b=>X(n)},[e("div",{class:D(`q-pa-sm ${w.value.includes(n)?"bg-light-blue-3":"bg-grey-2"}`)},[t(pe,{filename:n.filename,image_id:n.image_id,signed_url:n.signed_url,owner_username:n.owner_username,title:n.title,comment_count:n.comment_count,requires_login:n.requires_login,bookmark:n.bookmark,bookmark_count:n.bookmark_count,show_buttons:!1,disable_link:!0},null,8,["filename","image_id","signed_url","owner_username","title","comment_count","requires_login","bookmark","bookmark_count"])],2)],8,Ce))),128))])])],64))}}),Te={class:"row bg-grey-2 q-pa-md"},qe={class:"col-12 mx-auto"},Qe={key:0,class:"q-mb-sm"},Le={class:"q-my-md"},Me={class:"text-h5"},De={class:"q-ml-md"},Pe={key:0},Ve={key:1},Ke={class:"row"},Ne={class:"col-12"},Ue={class:"text-body1",style:{"text-decoration":"underline"}},Be={style:{"text-decoration":"none"}},no=K({__name:"NovelCover",props:{novelTitle:{default:""},coverImage:{default:""},novelChapters:{},description:{default:""},novelId:{default:0},imageLinksToImageDetail:{type:Boolean,default:!1},ownerId:{},ownerUsername:{},thumbnail:{type:Boolean,default:!1},showOwnerMenu:{type:Boolean,default:!1}},emits:["imageUpdated"],setup(a,{emit:r}){const i=U(),c=i.isDebugMode;c&&console.debug("NovelCover loaded");const o=f(!1),_=f(""),w=q(()=>s.imageLinksToImageDetail?"":`/novel-title/${s.novelId}/${i.language}`),s=a,y=r;function $(u){return`/novel-chapter/${s.novelId}/${u}/${i.language}`}function C(){c&&console.debug("changeTitleCoverDialog triggered"),o.value=!0}function x(u){c&&console.debug("handleImageSelected"),u[0]!==void 0&&(c&&console.debug(u[0].image_id),_.value=u[0].image_id)}function Q(){c&&console.debug(`updateCoverImage: ${_.value}`),V.post(`/novels/set-cover/title/${s.novelId}/${_.value}/`).then(u=>{c&&console.debug(`${u.status} Cover image updated`),o.value=!1,y("imageUpdated")}).catch(u=>{console.error("API Error:",u),o.value=!1})}return N(()=>{c&&console.debug(s)}),(u,m)=>{const k=F("router-link");return v(),g(T,null,[e("div",Te,[e("div",qe,[u.showOwnerMenu?(v(),g("div",Qe,[e("span",{onClick:C,style:{cursor:"pointer",width:"auto"}},[t(H,{name:"image_search",size:"medium"}),m[1]||(m[1]=e("span",{class:"q-ml-xs"},"change cover image",-1))])])):S("",!0),t(k,{to:`/novel-title/${s.novelId}/${le(i).language}`,style:{"text-decoration":"none"}},{default:h(()=>[t(j,{imageId:s.coverImage,showTags:!1,"crop-aspect-ratio":1,"link-to":w.value},null,8,["imageId","link-to"]),e("div",Le,[e("span",Me,I(s.novelTitle),1),m[2]||(m[2]=O()),e("span",De,"by "+I(s.ownerUsername),1)]),e("div",null,I(s.description),1)]),_:1},8,["to"]),t(M,{class:"q-my-md"}),(v(!0),g(T,null,P(s.novelChapters,d=>(v(),g("div",{key:d.chapterTitle,class:"q-my-sm"},[s.thumbnail?S("",!0):(v(),g("div",Pe,[t(Ie,{"novel-id":u.novelId,coverImage:d.coverImage!==void 0&&d.coverImage!==null&&d.coverImage.length>0?d.coverImage:s.coverImage,description:d.description,chapterTitle:d.chapterTitle,"chapter-str-id":d.chapterStrId},null,8,["novel-id","coverImage","description","chapterTitle","chapter-str-id"]),t(M,{class:"q-my-md"})])),s.thumbnail?(v(),g("div",Ve,[e("div",Ke,[t(k,{to:$(d.chapterStrId),style:{"text-decoration":"none"}},{default:h(()=>[e("div",Ne,[e("div",Ue,I(d.chapterTitle)+": ",1),e("div",Be,I(d.description.substring(0,100))+"...",1)])]),_:2},1032,["to"])]),t(M,{class:"q-my-md"})])):S("",!0)]))),128))])]),t(ee,{modelValue:o.value,"onUpdate:modelValue":m[0]||(m[0]=d=>o.value=d),maximized:""},{default:h(()=>[t(Z,{style:{width:"700px","max-width":"80vw","max-height":"80vw"}},{default:h(()=>[t(B,null,{default:h(()=>m[3]||(m[3]=[e("div",{class:"text-h6"},"Select new cover image",-1)])),_:1}),t(Y,{align:"left",class:"text-primary"},{default:h(()=>[R(t(E,{flat:"",label:"Set image",onClick:Q},null,512),[[A]]),R(t(E,{flat:"",label:"cancel"},null,512),[[A]])]),_:1}),t(B,{class:"q-pt-none"},{default:h(()=>[t(Se,{"owner-id":s.ownerId,onImageSelected:x},null,8,["owner-id"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}});export{no as _};
